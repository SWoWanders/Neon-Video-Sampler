<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Sampler | Video Performance Deck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-lime: #ccff00;
            --neon-red: #ff0055;
            --neon-orange: #ff9500;
            --bg-dark: #050505;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        html, body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .glow-text { text-shadow: 0 0 5px var(--neon-blue); }
        .glow-active { box-shadow: 0 0 15px var(--neon-blue), inset 0 0 8px var(--neon-blue); border-color: var(--neon-blue) !important; }
        .glow-record { box-shadow: 0 0 15px var(--neon-red); animation: pulse-red 1.5s infinite; }
        .glow-metronome { box-shadow: 0 0 10px var(--neon-orange); }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(255, 0, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); }
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 24px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: var(--neon-blue);
            cursor: pointer;
            box-shadow: 0 0 8px var(--neon-blue);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        .trigger-btn {
            transition: all 0.08s ease;
        }
        .trigger-btn:active, .trigger-btn.active {
            transform: scale(0.96);
            background-color: rgba(0, 243, 255, 0.15);
        }

        .upload-btn {
            transition: all 0.2s ease;
        }
        .upload-btn:active {
            transform: scale(0.98);
        }

        .loader {
            border: 3px solid #333;
            border-top: 3px solid var(--neon-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast-container {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            background: #1a1a1a;
            border-left: 3px solid var(--neon-red);
            padding: 12px 16px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border-radius: 0 8px 8px 0;
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
            font-size: 14px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--neon-lime); }

        .metronome-beat {
            animation: beat 0.1s ease-out;
        }
        @keyframes beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Desktop Layout */
        .desktop-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .desktop-sidebar {
            width: 320px;
            min-width: 320px;
            background: #121212;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .desktop-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: #000;
        }

        .desktop-triggers {
            height: 140px;
            background: #0f0f0f;
            border-bottom: 1px solid #333;
            padding: 16px;
            flex-shrink: 0;
        }

        .desktop-canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: #050505;
            position: relative;
            min-height: 0;
        }

        /* Mobile Layout */
        .mobile-layout {
            display: none;
            min-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(5, 5, 5, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .mobile-content {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .mobile-section {
            background: #121212;
            border: 1px solid #333;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        /* Scrollbar for desktop */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--neon-blue);
        }

        /* Media query switch */
        @media (max-width: 1024px) {
            .desktop-layout { display: none !important; }
            .mobile-layout { display: block !important; }
            
            #toast-container {
                left: 16px;
                right: 16px;
            }
            .toast {
                transform: translateY(100%);
                border-left: none;
                border-bottom: 3px solid var(--neon-red);
                border-radius: 8px;
            }
            .toast.show { transform: translateY(0); }
        }

        @media (min-width: 1025px) {
            .desktop-layout { display: flex !important; }
            .mobile-layout { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- DESKTOP LAYOUT -->
    <div class="desktop-layout" id="desktop-view">
        
        <!-- Sidebar -->
        <aside class="desktop-sidebar">
            <div class="p-4 border-b border-gray-800 flex items-center gap-3">
                <div class="w-3 h-3 bg-[var(--neon-blue)] rounded-full shadow-[0_0_10px_var(--neon-blue)]"></div>
                <h1 class="text-xl font-bold tracking-wider text-white uppercase glow-text">Neon<span class="text-[var(--neon-blue)]">Sampler</span></h1>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                
                <!-- Metronome -->
                <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold text-gray-300">Metronome</span>
                        <div class="flex items-center gap-2">
                            <div id="metro-light-d" class="w-3 h-3 rounded-full bg-gray-600 transition-all"></div>
                            <button id="btn-metro-d" class="px-3 py-1.5 bg-[var(--neon-orange)] text-black text-xs font-bold rounded hover:bg-white transition-colors">START</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500 w-8">BPM</span>
                            <input type="range" id="bpm-d" min="40" max="200" value="120" class="flex-1">
                            <span id="bpm-val-d" class="text-xs text-[var(--neon-orange)] font-mono w-8 text-right">120</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500 w-8">VOL</span>
                            <input type="range" id="vol-metro-d" min="0" max="1" step="0.1" value="0.5" class="flex-1">
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer mt-2">
                            <input type="checkbox" id="rec-metro-d" class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-[var(--neon-lime)]">
                            <span class="text-xs text-gray-400">Include metronome in recording</span>
                        </label>
                    </div>
                </div>

                <!-- Beat Player -->
                <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold text-gray-300">Background Beat</span>
                        <button id="play-beat-d" class="w-10 h-10 bg-[var(--neon-blue)] text-black rounded-lg flex items-center justify-center disabled:opacity-50 hover:bg-white transition-colors" disabled>
                            <svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 5.84a.75.75 0 011.06-.04l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 11-1.02-1.1L10.23 10 6.34 6.02a.75.75 0 01-.04-1.06v-.12z"/></svg>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <input type="file" id="audio-d" accept="audio/*" class="hidden">
                        <button onclick="document.getElementById('audio-d').click()" class="flex-1 py-2 border border-dashed border-gray-600 text-gray-400 text-xs rounded hover:border-white hover:text-white transition-colors">+ Upload Beat</button>
                    </div>
                    <div id="beat-name-d" class="text-xs text-[var(--neon-lime)] mb-2 hidden truncate"></div>
                    <canvas id="viz-d" class="w-full h-12 bg-black rounded border border-gray-700 mb-2" width="280" height="48"></canvas>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500 w-8">VOL</span>
                        <input type="range" id="vol-beat-d" min="0" max="1" step="0.1" value="0.7" class="flex-1">
                    </div>
                </div>

                <!-- Video Channels -->
                <div class="space-y-3">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Video Channels</h3>
                    
                    <!-- CH 1 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 1</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-d-1"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-d-1">00:00</span>
                        </div>
                        <input type="file" id="video-d-1" accept="video/*" class="hidden" onchange="handleVideo(1, this, 'd')">
                        <button onclick="document.getElementById('video-d-1').click()" class="w-full h-20 bg-black border border-gray-700 rounded flex items-center justify-center relative overflow-hidden mb-2 hover:border-[var(--neon-blue)] transition-colors group">
                            <span class="text-gray-500 text-xs z-10 group-hover:text-[var(--neon-blue)]">Click to Load Video</span>
                            <video id="preview-d-1" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-d-1"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-d-1">0%</span>
                        </div>
                        <input type="range" id="scrub-d-1" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 2 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 2</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-d-2"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-d-2">00:00</span>
                        </div>
                        <input type="file" id="video-d-2" accept="video/*" class="hidden" onchange="handleVideo(2, this, 'd')">
                        <button onclick="document.getElementById('video-d-2').click()" class="w-full h-20 bg-black border border-gray-700 rounded flex items-center justify-center relative overflow-hidden mb-2 hover:border-[var(--neon-blue)] transition-colors group">
                            <span class="text-gray-500 text-xs z-10 group-hover:text-[var(--neon-blue)]">Click to Load Video</span>
                            <video id="preview-d-2" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-d-2"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-d-2">0%</span>
                        </div>
                        <input type="range" id="scrub-d-2" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 3 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 3</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-d-3"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-d-3">00:00</span>
                        </div>
                        <input type="file" id="video-d-3" accept="video/*" class="hidden" onchange="handleVideo(3, this, 'd')">
                        <button onclick="document.getElementById('video-d-3').click()" class="w-full h-20 bg-black border border-gray-700 rounded flex items-center justify-center relative overflow-hidden mb-2 hover:border-[var(--neon-blue)] transition-colors group">
                            <span class="text-gray-500 text-xs z-10 group-hover:text-[var(--neon-blue)]">Click to Load Video</span>
                            <video id="preview-d-3" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-d-3"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-d-3">0%</span>
                        </div>
                        <input type="range" id="scrub-d-3" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 4 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 4</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-d-4"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-d-4">00:00</span>
                        </div>
                        <input type="file" id="video-d-4" accept="video/*" class="hidden" onchange="handleVideo(4, this, 'd')">
                        <button onclick="document.getElementById('video-d-4').click()" class="w-full h-20 bg-black border border-gray-700 rounded flex items-center justify-center relative overflow-hidden mb-2 hover:border-[var(--neon-blue)] transition-colors group">
                            <span class="text-gray-500 text-xs z-10 group-hover:text-[var(--neon-blue)]">Click to Load Video</span>
                            <video id="preview-d-4" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-d-4"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-d-4">0%</span>
                        </div>
                        <input type="range" id="scrub-d-4" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Area -->
        <main class="desktop-main">
            <!-- Triggers -->
            <div class="desktop-triggers">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs text-gray-500 font-mono">TRIGGER PADS [1] [2] [3] [4]</span>
                    <div class="flex items-center gap-3">
                        <div id="rec-ind-d" class="hidden flex items-center gap-2 text-[var(--neon-red)] font-bold animate-pulse">
                            <div class="w-2 h-2 bg-[var(--neon-red)] rounded-full"></div>
                            <span class="font-mono" id="timer-d">00:00</span>
                        </div>
                        <button id="btn-rec-d" class="px-4 py-2 bg-transparent border border-[var(--neon-red)] text-[var(--neon-red)] font-bold text-sm rounded hover:bg-[var(--neon-red)] hover:text-white transition-all flex items-center gap-2">
                            <div class="w-2 h-2 bg-current rounded-full"></div>
                            Record
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-3 h-16">
                    <button class="trigger-btn bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex items-center justify-center hover:border-[var(--neon-blue)]" data-ch="1">
                        <span class="text-2xl font-bold text-gray-500 hover:text-[var(--neon-blue)]">1</span>
                    </button>
                    <button class="trigger-btn bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex items-center justify-center hover:border-[var(--neon-blue)]" data-ch="2">
                        <span class="text-2xl font-bold text-gray-500 hover:text-[var(--neon-blue)]">2</span>
                    </button>
                    <button class="trigger-btn bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex items-center justify-center hover:border-[var(--neon-blue)]" data-ch="3">
                        <span class="text-2xl font-bold text-gray-500 hover:text-[var(--neon-blue)]">3</span>
                    </button>
                    <button class="trigger-btn bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex items-center justify-center hover:border-[var(--neon-blue)]" data-ch="4">
                        <span class="text-2xl font-bold text-gray-500 hover:text-[var(--neon-blue)]">4</span>
                    </button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="desktop-canvas-area">
                <canvas id="canvas-d" class="max-w-full max-h-full shadow-2xl border border-gray-800 bg-black crt" width="1280" height="720"></canvas>
                <div id="no-sig-d" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="text-center opacity-30">
                        <div class="text-6xl mb-2">ðŸ“¼</div>
                        <div class="text-xl font-mono tracking-widest">NO SIGNAL</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MOBILE LAYOUT -->
    <div class="mobile-layout" id="mobile-view">
        
        <!-- Header -->
        <header class="mobile-header px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-2.5 h-2.5 bg-[var(--neon-blue)] rounded-full shadow-[0_0_8px_var(--neon-blue)]"></div>
                    <h1 class="text-lg font-bold tracking-wider text-white uppercase glow-text">Neon<span class="text-[var(--neon-blue)]">Sampler</span></h1>
                </div>
                <div class="flex items-center gap-3">
                    <div id="metro-display-m" class="hidden flex items-center gap-2 px-2 py-1 bg-[#1a1a1a] rounded-lg border border-gray-700">
                        <div id="metro-light-m" class="w-2.5 h-2.5 rounded-full bg-gray-600 transition-all"></div>
                        <span id="bpm-display-m" class="text-sm font-bold text-[var(--neon-orange)] font-mono">120</span>
                    </div>
                    <div id="rec-ind-m" class="hidden flex items-center gap-1.5 text-[var(--neon-red)] font-bold text-sm">
                        <div class="w-2 h-2 bg-[var(--neon-red)] rounded-full animate-pulse"></div>
                        <span id="timer-m" class="font-mono">00:00</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content -->
        <div class="mobile-content">
            
            <!-- Performance -->
            <div class="mobile-section">
                <div class="p-3 border-b border-gray-800 flex items-center justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Performance</span>
                    <span class="text-[10px] text-gray-500 font-mono">KEYS 1-4</span>
                </div>
                
                <div class="relative bg-black aspect-video">
                    <canvas id="canvas-m" class="w-full h-full object-contain crt" width="1280" height="720"></canvas>
                    <div id="no-sig-m" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="text-center opacity-30">
                            <div class="text-5xl mb-1">ðŸ“¼</div>
                            <div class="text-sm font-mono tracking-widest">NO SIGNAL</div>
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-[#0a0a0a]">
                    <div class="grid grid-cols-4 gap-2">
                        <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center py-4 active:border-[var(--neon-blue)]" data-ch="1">
                            <span class="text-2xl font-bold text-gray-500 active:text-[var(--neon-blue)]">1</span>
                        </button>
                        <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center py-4 active:border-[var(--neon-blue)]" data-ch="2">
                            <span class="text-2xl font-bold text-gray-500 active:text-[var(--neon-blue)]">2</span>
                        </button>
                        <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center py-4 active:border-[var(--neon-blue)]" data-ch="3">
                            <span class="text-2xl font-bold text-gray-500 active:text-[var(--neon-blue)]">3</span>
                        </button>
                        <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-xl flex flex-col items-center justify-center py-4 active:border-[var(--neon-blue)]" data-ch="4">
                            <span class="text-2xl font-bold text-gray-500 active:text-[var(--neon-blue)]">4</span>
                        </button>
                    </div>
                    <button id="btn-rec-m" class="mt-3 w-full py-3 bg-transparent border-2 border-[var(--neon-red)] text-[var(--neon-red)] font-bold uppercase tracking-wider rounded-xl active:scale-98 flex items-center justify-center gap-2 transition-all">
                        <div class="w-3 h-3 bg-current rounded-full"></div>
                        <span>Record Performance</span>
                    </button>
                </div>
            </div>

            <!-- Audio -->
            <div class="mobile-section">
                <div class="p-3 border-b border-gray-800">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Audio Engine</span>
                </div>
                <div class="p-3 space-y-4">
                    
                    <!-- Metronome -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-300">Metronome</span>
                            <button id="btn-metro-m" class="px-4 py-1.5 bg-[var(--neon-orange)] text-black text-xs font-bold rounded-lg active:scale-95 transition-transform">START</button>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-500 w-8">BPM</span>
                            <input type="range" id="bpm-m" min="40" max="200" value="120" class="flex-1">
                            <span id="bpm-val-m" class="text-xs text-[var(--neon-orange)] font-mono w-8 text-right">120</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-500 w-8">VOL</span>
                            <input type="range" id="vol-metro-m" min="0" max="1" step="0.1" value="0.5" class="flex-1">
                        </div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="rec-metro-m" class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-[var(--neon-lime)]">
                            <span class="text-xs text-gray-400">Include in recording</span>
                        </label>
                    </div>

                    <!-- Beat -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold text-gray-300">Background Beat</span>
                            <button id="play-beat-m" class="w-10 h-10 bg-[var(--neon-blue)] text-black rounded-full flex items-center justify-center disabled:opacity-50 active:scale-95 transition-transform" disabled>
                                <svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 5.84a.75.75 0 011.06-.04l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 11-1.02-1.1L10.23 10 6.34 6.02a.75.75 0 01-.04-1.06v-.12z"/></svg>
                            </button>
                        </div>
                        <input type="file" id="audio-m" accept="audio/*" class="hidden">
                        <button onclick="document.getElementById('audio-m').click()" class="w-full py-2.5 border-2 border-dashed border-gray-600 text-gray-400 text-sm rounded-lg active:border-[var(--neon-blue)] active:text-[var(--neon-blue)] transition-colors">
                            + Upload Beat
                        </button>
                        <div id="beat-name-m" class="text-xs text-[var(--neon-lime)] hidden"></div>
                        <canvas id="viz-m" class="w-full h-12 bg-black rounded-lg border border-gray-700" width="300" height="48"></canvas>
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-500 w-8">VOL</span>
                            <input type="range" id="vol-beat-m" min="0" max="1" step="0.1" value="0.7" class="flex-1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Videos -->
            <div class="mobile-section">
                <div class="p-3 border-b border-gray-800">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Video Channels</span>
                </div>
                <div class="p-3 space-y-3">
                    
                    <!-- CH 1 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 1</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-m-1"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-m-1">00:00</span>
                        </div>
                        <input type="file" id="video-m-1" accept="video/*" class="hidden" onchange="handleVideo(1, this, 'm')">
                        <button onclick="document.getElementById('video-m-1').click()" class="upload-btn w-full h-24 bg-black border-2 border-gray-700 rounded-lg flex items-center justify-center relative overflow-hidden mb-2 active:border-[var(--neon-blue)]">
                            <span class="text-gray-500 text-sm z-10">Tap to Load Video</span>
                            <video id="preview-m-1" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-m-1"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-m-1">0%</span>
                        </div>
                        <input type="range" id="scrub-m-1" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 2 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 2</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-m-2"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-m-2">00:00</span>
                        </div>
                        <input type="file" id="video-m-2" accept="video/*" class="hidden" onchange="handleVideo(2, this, 'm')">
                        <button onclick="document.getElementById('video-m-2').click()" class="upload-btn w-full h-24 bg-black border-2 border-gray-700 rounded-lg flex items-center justify-center relative overflow-hidden mb-2 active:border-[var(--neon-blue)]">
                            <span class="text-gray-500 text-sm z-10">Tap to Load Video</span>
                            <video id="preview-m-2" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-m-2"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-m-2">0%</span>
                        </div>
                        <input type="range" id="scrub-m-2" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 3 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 3</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-m-3"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-m-3">00:00</span>
                        </div>
                        <input type="file" id="video-m-3" accept="video/*" class="hidden" onchange="handleVideo(3, this, 'm')">
                        <button onclick="document.getElementById('video-m-3').click()" class="upload-btn w-full h-24 bg-black border-2 border-gray-700 rounded-lg flex items-center justify-center relative overflow-hidden mb-2 active:border-[var(--neon-blue)]">
                            <span class="text-gray-500 text-sm z-10">Tap to Load Video</span>
                            <video id="preview-m-3" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-m-3"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-m-3">0%</span>
                        </div>
                        <input type="range" id="scrub-m-3" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                    <!-- CH 4 -->
                    <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-700">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-[var(--neon-blue)] text-sm">CH 4</span>
                                <div class="w-2 h-2 rounded-full bg-gray-700" id="status-m-4"></div>
                            </div>
                            <span class="text-xs text-gray-500 font-mono" id="time-m-4">00:00</span>
                        </div>
                        <input type="file" id="video-m-4" accept="video/*" class="hidden" onchange="handleVideo(4, this, 'm')">
                        <button onclick="document.getElementById('video-m-4').click()" class="upload-btn w-full h-24 bg-black border-2 border-gray-700 rounded-lg flex items-center justify-center relative overflow-hidden mb-2 active:border-[var(--neon-blue)]">
                            <span class="text-gray-500 text-sm z-10">Tap to Load Video</span>
                            <video id="preview-m-4" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden" id="loader-m-4"></div>
                        </button>
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>Start Point</span>
                            <span id="start-val-m-4">0%</span>
                        </div>
                        <input type="range" id="scrub-m-4" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                    </div>

                </div>
            </div>

            <div class="h-8"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Modal -->
    <div id="modal-exp" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[#121212] border border-gray-700 rounded-2xl w-full max-w-sm p-6">
            <div class="w-full h-1 bg-gradient-to-r from-[var(--neon-blue)] to-[var(--neon-lime)] rounded-full mb-4"></div>
            <h2 class="text-xl font-bold text-white mb-1 text-center">Performance Saved</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Your session is ready</p>
            <div class="space-y-3">
                <button id="btn-watch" class="w-full py-3 bg-[var(--neon-blue)] text-black font-bold uppercase rounded-xl">Watch</button>
                <button id="btn-download" class="w-full py-3 border-2 border-[var(--neon-lime)] text-[var(--neon-lime)] font-bold uppercase rounded-xl">Download MP4</button>
                <button id="btn-close" class="w-full py-2 text-gray-500 text-sm">Close</button>
            </div>
        </div>
    </div>

    <!-- Hidden Videos -->
    <div class="hidden">
        <video id="src-1" playsinline></video>
        <video id="src-2" playsinline></video>
        <video id="src-3" playsinline></video>
        <video id="src-4" playsinline></video>
    </div>

    <script>
        // State
        const state = {
            channels: { 1: {}, 2: {}, 3: {}, 4: {} },
            activeChannel: null,
            isRecording: false,
            mediaRecorder: null,
            recordedChunks: [],
            audioContext: null,
            customAudioElement: null,
            audioGainNode: null,
            audioAnalyser: null,
            audioDataArray: null,
            isPlaying: false,
            timerInterval: null,
            metronome: { isActive: false, bpm: 120, volume: 0.5, includeInRecording: false, gainNode: null, nextNoteTime: 0 }
        };

        function getEl(id) { return document.getElementById(id); }

        function init() {
            setupAudio();
            setupMetronome();
            setupBeat();
            setupTriggers();
            setupRecording();
            requestAnimationFrame(renderLoop);
            requestAnimationFrame(drawVisualizer);
        }

        function setupAudio() {
            const initCtx = () => {
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (state.audioContext.state === 'suspended') state.audioContext.resume();
            };
            document.body.addEventListener('click', initCtx, { once: true });
            document.body.addEventListener('touchstart', initCtx, { once: true });
        }

        // AUDIO VISUALIZER - Fixed implementation
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            
            // Determine which canvas to draw to based on screen size
            const isMobile = window.innerWidth < 1025;
            const canvasId = isMobile ? 'viz-m' : 'viz-d';
            const canvas = getEl(canvasId);
            
            if (!canvas || !state.audioAnalyser || !state.isPlaying) {
                // Clear canvas if not playing
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                return;
            }

            const ctx = canvas.getContext('2d');
            const bufferLength = state.audioAnalyser.frequencyBinCount;
            
            // Get frequency data
            state.audioAnalyser.getByteFrequencyData(state.audioDataArray);
            
            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw bars
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const barHeight = (state.audioDataArray[i] / 255) * canvas.height * 0.8;
                
                // Gradient color based on frequency
                const hue = 180 + (i / bufferLength) * 60; // Cyan to blue
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                
                // Draw rounded bar
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }

        // Metronome
        function setupMetronome() {
            const toggle = (isM) => {
                const btn = getEl(isM ? 'btn-metro-m' : 'btn-metro-d');
                const light = getEl(isM ? 'metro-light-m' : 'metro-light-d');
                const display = getEl('metro-display-m');

                if (state.metronome.isActive) {
                    state.metronome.isActive = false;
                    cancelAnimationFrame(state.metronome.intervalId);
                    btn.textContent = 'START';
                    btn.classList.remove('bg-red-500');
                    btn.classList.add('bg-[var(--neon-orange)]');
                    if (display) display.classList.add('hidden');
                } else {
                    if (!state.audioContext) setupAudio();
                    if (!state.metronome.gainNode) {
                        state.metronome.gainNode = state.audioContext.createGain();
                        state.metronome.gainNode.gain.value = state.metronome.volume;
                        state.metronome.gainNode.connect(state.audioContext.destination);
                    }
                    state.metronome.isActive = true;
                    state.metronome.nextNoteTime = state.audioContext.currentTime;
                    schedule();
                    btn.textContent = 'STOP';
                    btn.classList.remove('bg-[var(--neon-orange)]');
                    btn.classList.add('bg-red-500');
                    if (display) display.classList.remove('hidden');
                }
            };

            const playClick = () => {
                const t = state.audioContext.currentTime;
                const osc = state.audioContext.createOscillator();
                const gain = state.audioContext.createGain();
                osc.frequency.setValueAtTime(1000, t);
                osc.type = 'square';
                gain.gain.setValueAtTime(state.metronome.volume, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
                osc.connect(gain);
                gain.connect(state.metronome.gainNode);
                osc.start(t);
                osc.stop(t + 0.05);

                const light = getEl(window.innerWidth < 1025 ? 'metro-light-m' : 'metro-light-d');
                if (light) {
                    light.classList.add('bg-[var(--neon-orange)]', 'metronome-beat');
                    light.classList.remove('bg-gray-600');
                    setTimeout(() => {
                        light.classList.remove('bg-[var(--neon-orange)]', 'metronome-beat');
                        light.classList.add('bg-gray-600');
                    }, 100);
                }
            };

            const schedule = () => {
                const secondsPerBeat = 60.0 / state.metronome.bpm;
                while (state.metronome.nextNoteTime < state.audioContext.currentTime + 0.1) {
                    playClick();
                    state.metronome.nextNoteTime += secondsPerBeat;
                }
                if (state.metronome.isActive) {
                    state.metronome.intervalId = requestAnimationFrame(schedule);
                }
            };

            ['btn-metro-m', 'btn-metro-d'].forEach(id => {
                const btn = getEl(id);
                if (btn) btn.addEventListener('click', () => toggle(id.includes('m')));
            });

            ['bpm-m', 'bpm-d'].forEach(id => {
                const el = getEl(id);
                if (el) el.addEventListener('input', (e) => {
                    state.metronome.bpm = parseInt(e.target.value);
                    const valEl = getEl(id.replace('bpm', 'bpm-val')) || getEl(id.replace('bpm', 'bpm-display'));
                    if (valEl) valEl.textContent = state.metronome.bpm;
                });
            });

            ['vol-metro-m', 'vol-metro-d'].forEach(id => {
                const el = getEl(id);
                if (el) el.addEventListener('input', (e) => {
                    state.metronome.volume = parseFloat(e.target.value);
                    if (state.metronome.gainNode) state.metronome.gainNode.gain.value = state.metronome.volume;
                });
            });

            ['rec-metro-m', 'rec-metro-d'].forEach(id => {
                const el = getEl(id);
                if (el) el.addEventListener('change', (e) => {
                    state.metronome.includeInRecording = e.target.checked;
                });
            });
        }

        // Beat - Fixed with proper audio analyser setup
        function setupBeat() {
            const toggle = (isM) => {
                if (!state.customAudioElement) return;
                const btn = getEl(isM ? 'play-beat-m' : 'play-beat-d');
                const playIcon = isM ? 
                    '<svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 5.84a.75.75 0 011.06-.04l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 11-1.02-1.1L10.23 10 6.34 6.02a.75.75 0 01-.04-1.06v-.12z"/></svg>' :
                    '<svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 5.84a.75.75 0 011.06-.04l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 11-1.02-1.1L10.23 10 6.34 6.02a.75.75 0 01-.04-1.06v-.12z"/></svg>';
                const pauseIcon = isM ?
                    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>' :
                    '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';

                if (state.isPlaying) {
                    state.customAudioElement.pause();
                    btn.innerHTML = playIcon;
                    state.isPlaying = false;
                } else {
                    state.customAudioElement.play();
                    btn.innerHTML = pauseIcon;
                    state.isPlaying = true;
                }
            };

            const handleUpload = (e, isM) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!state.audioContext) setupAudio();

                const url = URL.createObjectURL(file);
                if (state.customAudioElement) state.customAudioElement.pause();

                const audio = new Audio(url);
                audio.loop = true;
                audio.crossOrigin = 'anonymous';
                state.customAudioElement = audio;

                // Create audio graph with analyser
                const source = state.audioContext.createMediaElementSource(audio);
                
                // Create analyser
                const analyser = state.audioContext.createAnalyser();
                analyser.fftSize = 64;
                state.audioAnalyser = analyser;
                state.audioDataArray = new Uint8Array(analyser.frequencyBinCount);
                
                // Create gain node for volume control
                const gainNode = state.audioContext.createGain();
                gainNode.gain.value = getEl(isM ? 'vol-beat-m' : 'vol-beat-d').value;
                
                // Connect: source -> analyser -> gain -> destination
                source.connect(analyser);
                analyser.connect(gainNode);
                gainNode.connect(state.audioContext.destination);
                
                state.audioGainNode = gainNode;

                const nameId = isM ? 'beat-name-m' : 'beat-name-d';
                const playId = isM ? 'play-beat-m' : 'play-beat-d';
                getEl(nameId).textContent = file.name;
                getEl(nameId).classList.remove('hidden');
                getEl(playId).disabled = false;
                showToast('Beat loaded', 'success');
            };

            ['audio-m', 'audio-d'].forEach((id, i) => {
                const el = getEl(id);
                if (el) el.addEventListener('change', (e) => handleUpload(e, i === 0));
            });

            ['play-beat-m', 'play-beat-d'].forEach((id, i) => {
                const el = getEl(id);
                if (el) el.addEventListener('click', () => toggle(i === 0));
            });

            ['vol-beat-m', 'vol-beat-d'].forEach(id => {
                const el = getEl(id);
                if (el) el.addEventListener('input', (e) => {
                    if (state.audioGainNode) state.audioGainNode.gain.value = e.target.value;
                    if (state.customAudioElement) state.customAudioElement.volume = e.target.value;
                });
            });
        }

        // Video upload
        window.handleVideo = (ch, input, platform) => {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 100 * 1024 * 1024) {
                showToast('File too large (Max 100MB)', 'error');
                return;
            }

            const isM = platform === 'm';
            const loader = getEl(`loader-${platform}-${ch}`);
            const preview = getEl(`preview-${platform}-${ch}`);
            
            if (loader) loader.classList.remove('hidden');

            const url = URL.createObjectURL(file);
            const videoEl = getEl(`src-${ch}`);
            videoEl.src = url;
            if (preview) preview.src = url;

            videoEl.onloadedmetadata = () => {
                if (loader) loader.classList.add('hidden');
                if (preview) preview.classList.remove('hidden');
                
                state.channels[ch].video = videoEl;
                state.channels[ch].duration = videoEl.duration;
                state.channels[ch].loaded = true;

                const status = getEl(`status-${platform}-${ch}`);
                const time = getEl(`time-${platform}-${ch}`);
                const scrub = getEl(`scrub-${platform}-${ch}`);
                
                if (status) status.classList.replace('bg-gray-700', 'bg-[var(--neon-lime)]');
                if (time) time.textContent = formatTime(videoEl.duration);
                if (scrub) {
                    scrub.disabled = false;
                    scrub.classList.remove('opacity-50');
                    scrub.oninput = (e) => {
                        const pct = e.target.value;
                        const time = (pct / 100) * videoEl.duration;
                        state.channels[ch].startTime = time;
                        const valEl = getEl(`start-val-${platform}-${ch}`);
                        if (valEl) valEl.textContent = pct + '%';
                        if (preview) preview.currentTime = time;
                    };
                }
            };

            videoEl.onerror = () => {
                if (loader) loader.classList.add('hidden');
                showToast('Error loading video', 'error');
            };
        };

        // Triggers
        function setupTriggers() {
            const trigger = (ch, isActive) => {
                const btns = document.querySelectorAll(`[data-ch="${ch}"]`);
                const videoEl = state.channels[ch].video;
                const isMobile = window.innerWidth < 1025;

                btns.forEach(btn => {
                    if (isActive) {
                        btn.classList.add('active', 'glow-active');
                        if (videoEl) {
                            videoEl.currentTime = state.channels[ch].startTime || 0;
                            videoEl.muted = false;
                            videoEl.play();
                            state.activeChannel = ch;
                            const noSig = getEl(isMobile ? 'no-sig-m' : 'no-sig-d');
                            if (noSig) noSig.style.opacity = '0';
                        }
                    } else {
                        btn.classList.remove('active', 'glow-active');
                        if (state.activeChannel === ch) {
                            if (videoEl) videoEl.pause();
                            state.activeChannel = null;
                            const noSig = getEl(isMobile ? 'no-sig-m' : 'no-sig-d');
                            if (noSig) noSig.style.opacity = '1';
                        }
                    }
                });
            };

            document.querySelectorAll('[data-ch]').forEach(btn => {
                const ch = parseInt(btn.dataset.ch);
                
                const start = (e) => { e.preventDefault(); trigger(ch, true); };
                const end = (e) => { e.preventDefault(); trigger(ch, false); };

                btn.addEventListener('touchstart', start, { passive: false });
                btn.addEventListener('touchend', end);
                btn.addEventListener('touchcancel', end);
                btn.addEventListener('mousedown', start);
                btn.addEventListener('mouseup', end);
                btn.addEventListener('mouseleave', end);
            });

            window.addEventListener('keydown', (e) => {
                if (e.repeat) return;
                if (['1','2','3','4'].includes(e.key)) trigger(parseInt(e.key), true);
            });
            window.addEventListener('keyup', (e) => {
                if (['1','2','3','4'].includes(e.key)) trigger(parseInt(e.key), false);
            });
        }

        // Recording
        function setupRecording() {
            const stopAll = () => {
                Object.values(state.channels).forEach(ch => {
                    if (ch.video) ch.video.pause();
                });
                document.querySelectorAll('[data-ch]').forEach(btn => {
                    btn.classList.remove('active', 'glow-active');
                });
                state.activeChannel = null;
                ['no-sig-m', 'no-sig-d'].forEach(id => {
                    const el = getEl(id);
                    if (el) el.style.opacity = '1';
                });
                if (state.customAudioElement) {
                    state.customAudioElement.pause();
                    state.isPlaying = false;
                }
                if (state.metronome.isActive) {
                    const btn = getEl(window.innerWidth < 1025 ? 'btn-metro-m' : 'btn-metro-d');
                    if (btn) btn.click();
                }
            };

            const startRec = async () => {
                const hasVideo = Object.values(state.channels).some(c => c.loaded);
                if (!hasVideo) {
                    showToast('Load at least one video first!', 'error');
                    return;
                }

                if (!state.audioContext) setupAudio();
                if (state.customAudioElement) {
                    state.customAudioElement.currentTime = 0;
                    state.customAudioElement.play();
                    state.isPlaying = true;
                }

                const isMobile = window.innerWidth < 1025;
                const canvasEl = getEl(isMobile ? 'canvas-m' : 'canvas-d');
                const canvasStream = canvasEl.captureStream(30);
                const dest = state.audioContext.createMediaStreamDestination();

                Object.values(state.channels).forEach(ch => {
                    if (ch.video) {
                        try {
                            const vStream = ch.video.captureStream();
                            const track = vStream.getAudioTracks()[0];
                            if (track) {
                                const src = state.audioContext.createMediaStreamSource(new MediaStream([track]));
                                src.connect(dest);
                            }
                        } catch(e) {}
                    }
                });

                if (state.audioGainNode) state.audioGainNode.connect(dest);
                
                if (state.metronome.isActive && state.metronome.includeInRecording && state.metronome.gainNode) {
                    state.metronome.gainNode.connect(dest);
                }

                const combined = new MediaStream([...canvasStream.getVideoTracks(), ...dest.stream.getAudioTracks()]);
                state.mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp9,opus' });
                state.recordedChunks = [];

                state.mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) state.recordedChunks.push(e.data);
                };

                state.mediaRecorder.onstop = () => {
                    if (state.metronome.gainNode && state.metronome.includeInRecording) {
                        try { state.metronome.gainNode.disconnect(dest); } catch(e) {}
                    }
                    stopAll();

                    const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    getEl('modal-exp').classList.remove('hidden');
                    getEl('btn-download').onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `performance-${Date.now()}.webm`;
                        a.click();
                    };
                    getEl('btn-watch').onclick = () => {
                        const win = window.open();
                        win.document.write(`<iframe src="${url}" frameborder="0" style="border:0;width:100%;height:100%;" allowfullscreen></iframe>`);
                    };
                };

                state.mediaRecorder.start();
                state.isRecording = true;

                const recBtn = getEl(isMobile ? 'btn-rec-m' : 'btn-rec-d');
                const ind = getEl(isMobile ? 'rec-ind-m' : 'rec-ind-d');
                
                if (recBtn) {
                    recBtn.classList.add('glow-record');
                    recBtn.innerHTML = isMobile ? 
                        '<div class="w-3 h-3 bg-white rounded-sm"></div><span>Stop</span>' :
                        '<div class="w-2 h-2 bg-white rounded-sm"></div><span>Stop</span>';
                }
                if (ind) ind.classList.remove('hidden');

                let seconds = 0;
                const timer = getEl(isMobile ? 'timer-m' : 'timer-d');
                state.timerInterval = setInterval(() => {
                    seconds++;
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    if (timer) timer.textContent = `${m}:${s}`;
                }, 1000);

                showToast('Recording started', 'success');
            };

            const stopRec = () => {
                if (state.mediaRecorder && state.isRecording) {
                    state.mediaRecorder.stop();
                    state.isRecording = false;
                    
                    const isMobile = window.innerWidth < 1025;
                    const recBtn = getEl(isMobile ? 'btn-rec-m' : 'btn-rec-d');
                    const ind = getEl(isMobile ? 'rec-ind-m' : 'rec-ind-d');
                    
                    if (recBtn) {
                        recBtn.classList.remove('glow-record');
                        recBtn.innerHTML = isMobile ?
                            '<div class="w-3 h-3 bg-current rounded-full"></div><span>Record Performance</span>' :
                            '<div class="w-2 h-2 bg-current rounded-full"></div><span>Record</span>';
                    }
                    if (ind) ind.classList.add('hidden');
                    
                    clearInterval(state.timerInterval);
                    showToast('Processing...', 'success');
                }
            };

            ['btn-rec-m', 'btn-rec-d'].forEach(id => {
                const btn = getEl(id);
                if (btn) btn.addEventListener('click', () => {
                    if (state.isRecording) stopRec();
                    else startRec();
                });
            });

            getEl('btn-close')?.addEventListener('click', () => {
                getEl('modal-exp').classList.add('hidden');
                const isMobile = window.innerWidth < 1025;
                const recBtn = getEl(isMobile ? 'btn-rec-m' : 'btn-rec-d');
                if (recBtn) {
                    recBtn.classList.remove('glow-record');
                    recBtn.innerHTML = isMobile ?
                        '<div class="w-3 h-3 bg-current rounded-full"></div><span>Record Performance</span>' :
                        '<div class="w-2 h-2 bg-current rounded-full"></div><span>Record</span>';
                }
            });
        }

        // Render loop
        function renderLoop() {
            const isMobile = window.innerWidth < 1025;
            const canvas = getEl(isMobile ? 'canvas-m' : 'canvas-d');
            if (!canvas) {
                requestAnimationFrame(renderLoop);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (state.activeChannel && state.channels[state.activeChannel].video) {
                const video = state.channels[state.activeChannel].video;
                const scale = Math.min(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
                const x = (canvas.width / 2) - (video.videoWidth / 2) * scale;
                const y = (canvas.height / 2) - (video.videoHeight / 2) * scale;
                ctx.drawImage(video, x, y, video.videoWidth * scale, video.videoHeight * scale);
            }
            requestAnimationFrame(renderLoop);
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function showToast(msg, type = 'error') {
            const container = getEl('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span class="text-lg mr-2">${type === 'error' ? 'âš ï¸' : 'âœ…'}</span><span>${msg}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        let lastWasMobile = window.innerWidth < 1025;
        window.addEventListener('resize', () => {
            const isMobile = window.innerWidth < 1025;
            if (lastWasMobile !== isMobile) {
                location.reload();
            }
        });

        init();
    </script>
</body>
</html>
