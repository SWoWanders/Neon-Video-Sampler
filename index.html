<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Sampler | Video Performance Deck</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');

        :root {
            --neon-blue: #00f3ff;
            --neon-lime: #ccff00;
            --neon-red: #ff0055;
            --neon-orange: #ff9500;
            --bg-dark: #050505;
            --panel-bg: #121212;
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .glow-text { text-shadow: 0 0 5px var(--neon-blue); }
        .glow-active { box-shadow: 0 0 20px var(--neon-blue), inset 0 0 10px var(--neon-blue); border-color: var(--neon-blue) !important; }
        .glow-record { box-shadow: 0 0 20px var(--neon-red); animation: pulse-red 1.5s infinite; }
        .glow-metronome { box-shadow: 0 0 15px var(--neon-orange); }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 85, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); }
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--neon-blue);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px var(--neon-blue);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }

        .trigger-btn:active, .trigger-btn.active {
            transform: scale(0.95);
            background-color: rgba(0, 243, 255, 0.1);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #1a1a1a;
            border-left: 4px solid var(--neon-red);
            padding: 15px 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--neon-lime); }

        .truncate-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .break-words {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--neon-lime);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--neon-lime);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header -->
    <header class="h-14 border-b border-gray-800 flex items-center justify-between px-4 bg-[#0a0a0a] shrink-0">
        <div class="flex items-center gap-3 min-w-0">
            <div class="w-3 h-3 bg-[var(--neon-blue)] rounded-full shadow-[0_0_10px_var(--neon-blue)] shrink-0"></div>
            <h1 class="text-xl font-bold tracking-widest text-white uppercase glow-text truncate">Neon<span class="text-[var(--neon-blue)]">Sampler</span></h1>
        </div>
        
        <!-- Metronome Display (Header) -->
        <div id="metronome-display" class="hidden flex items-center gap-3 px-3 py-1 bg-[#1a1a1a] rounded-lg border border-gray-700">
            <div id="metronome-light" class="w-3 h-3 rounded-full bg-gray-600 transition-all duration-75"></div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-400 uppercase">BPM</span>
                <span id="bpm-display" class="text-lg font-bold text-[var(--neon-orange)] font-mono">120</span>
            </div>
            <div class="h-4 w-px bg-gray-600"></div>
            <div class="flex items-center gap-2">
                <span class="text-[10px] text-gray-400 uppercase">Rec</span>
                <div class="relative inline-block w-8 align-middle select-none">
                    <input type="checkbox" name="toggle" id="metronome-record-toggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 left-0 top-0"/>
                    <label for="metronome-record-toggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-700 cursor-pointer"></label>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-3 shrink-0">
            <div id="recording-indicator" class="hidden flex items-center gap-2 text-[var(--neon-red)] font-bold animate-pulse">
                <div class="w-2 h-2 bg-[var(--neon-red)] rounded-full"></div>
                <span class="text-sm truncate">REC</span>
                <span id="rec-timer" class="font-mono text-sm">00:00</span>
            </div>
            <button id="btn-setup-toggle" class="px-3 py-1 border border-gray-600 rounded text-xs hover:border-[var(--neon-blue)] hover:text-[var(--neon-blue)] transition-colors whitespace-nowrap">
                Setup
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex overflow-hidden relative min-h-0">
        
        <!-- Left Sidebar: Media Setup -->
        <aside id="setup-panel" class="w-72 bg-[#121212] border-r border-gray-800 flex flex-col transition-all duration-300 z-20 shrink-0">
            <div class="p-3 border-b border-gray-800 shrink-0 space-y-3">
                <h2 class="text-[var(--neon-blue)] font-bold uppercase tracking-wider text-xs">Audio Engine</h2>
                
                <!-- Metronome Section -->
                <div class="bg-[#1a1a1a] p-2 rounded border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] text-gray-400 uppercase font-bold">Metronome</span>
                        <button id="btn-metronome" class="px-2 py-1 bg-[var(--neon-orange)] text-black text-[10px] font-bold rounded hover:bg-white transition-colors">
                            START
                        </button>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 w-6">BPM</span>
                            <input type="range" id="bpm-slider" min="40" max="200" value="120" class="flex-1">
                            <span id="bpm-value" class="text-[10px] text-[var(--neon-orange)] font-mono w-6 text-right">120</span>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500 w-6">VOL</span>
                            <input type="range" id="metronome-vol" min="0" max="1" step="0.1" value="0.5" class="flex-1">
                        </div>

                        <div class="flex items-center justify-between text-[9px] text-gray-400">
                            <span>Include in recording:</span>
                            <span id="metronome-record-status" class="text-[var(--neon-lime)]">NO</span>
                        </div>
                    </div>
                </div>

                <!-- Beat Player -->
                <div class="space-y-2">
                    <label class="text-[10px] text-gray-400 uppercase font-bold">Background Beat</label>
                    <div class="flex items-center gap-2">
                        <input type="file" id="audio-upload" accept="audio/*" class="hidden">
                        <button onclick="document.getElementById('audio-upload').click()" class="flex-1 py-1.5 border border-dashed border-gray-600 text-gray-400 text-[10px] hover:text-white hover:border-white transition-colors flex items-center justify-center gap-1 truncate-text">
                            <span class="truncate">+ Upload</span>
                        </button>
                        <button id="btn-play-beat" class="px-3 py-1.5 bg-[var(--neon-blue)] text-black font-bold text-[10px] rounded hover:bg-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ‚ñ∂
                        </button>
                    </div>
                    <div id="beat-filename" class="text-[9px] text-[var(--neon-lime)] hidden truncate-text"></div>
                    
                    <canvas id="audio-visualizer" class="w-full h-8 bg-black rounded border border-gray-700" width="260" height="32"></canvas>
                    
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-gray-500 shrink-0">VOL</span>
                        <input type="range" id="beat-vol" min="0" max="1" step="0.1" value="0.7" class="flex-1">
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 space-y-4 min-h-0">
                <h2 class="text-[var(--neon-blue)] font-bold uppercase tracking-wider text-xs shrink-0">Video Channels</h2>
                
                <!-- Channels 1-4 -->
                <div class="space-y-3">
                    <!-- Channel 1 -->
                    <div class="bg-[#1a1a1a] p-2 rounded border border-gray-800 relative group">
                        <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-gray-700 shrink-0" id="status-1"></div>
                        <div class="flex justify-between items-center mb-1 gap-1">
                            <span class="font-bold text-[var(--neon-blue)] text-xs shrink-0">CH 1</span>
                            <span class="text-[10px] text-gray-500 font-mono truncate-text" id="time-1">00:00</span>
                        </div>
                        <input type="file" id="video-1" accept="video/*" class="hidden" onchange="handleVideoUpload(1, this)">
                        <button onclick="document.getElementById('video-1').click()" class="w-full h-14 bg-black border border-gray-700 flex items-center justify-center mb-1 hover:border-[var(--neon-blue)] transition-colors relative overflow-hidden">
                            <span class="text-gray-600 text-[10px] z-10 truncate-text px-1">Load</span>
                            <video id="preview-1" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden w-4 h-4" id="loader-1"></div>
                        </button>
                        <div class="space-y-0.5">
                            <div class="flex justify-between text-[9px] text-gray-400 uppercase gap-1">
                                <span class="shrink-0">Start</span>
                                <span class="truncate-text" id="start-val-1">0%</span>
                            </div>
                            <input type="range" id="scrub-1" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                        </div>
                    </div>

                    <!-- Channel 2 -->
                    <div class="bg-[#1a1a1a] p-2 rounded border border-gray-800 relative group">
                        <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-gray-700 shrink-0" id="status-2"></div>
                        <div class="flex justify-between items-center mb-1 gap-1">
                            <span class="font-bold text-[var(--neon-blue)] text-xs shrink-0">CH 2</span>
                            <span class="text-[10px] text-gray-500 font-mono truncate-text" id="time-2">00:00</span>
                        </div>
                        <input type="file" id="video-2" accept="video/*" class="hidden" onchange="handleVideoUpload(2, this)">
                        <button onclick="document.getElementById('video-2').click()" class="w-full h-14 bg-black border border-gray-700 flex items-center justify-center mb-1 hover:border-[var(--neon-blue)] transition-colors relative overflow-hidden">
                            <span class="text-gray-600 text-[10px] z-10 truncate-text px-1">Load</span>
                            <video id="preview-2" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden w-4 h-4" id="loader-2"></div>
                        </button>
                        <div class="space-y-0.5">
                            <div class="flex justify-between text-[9px] text-gray-400 uppercase gap-1">
                                <span class="shrink-0">Start</span>
                                <span class="truncate-text" id="start-val-2">0%</span>
                            </div>
                            <input type="range" id="scrub-2" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                        </div>
                    </div>

                    <!-- Channel 3 -->
                    <div class="bg-[#1a1a1a] p-2 rounded border border-gray-800 relative group">
                        <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-gray-700 shrink-0" id="status-3"></div>
                        <div class="flex justify-between items-center mb-1 gap-1">
                            <span class="font-bold text-[var(--neon-blue)] text-xs shrink-0">CH 3</span>
                            <span class="text-[10px] text-gray-500 font-mono truncate-text" id="time-3">00:00</span>
                        </div>
                        <input type="file" id="video-3" accept="video/*" class="hidden" onchange="handleVideoUpload(3, this)">
                        <button onclick="document.getElementById('video-3').click()" class="w-full h-14 bg-black border border-gray-700 flex items-center justify-center mb-1 hover:border-[var(--neon-blue)] transition-colors relative overflow-hidden">
                            <span class="text-gray-600 text-[10px] z-10 truncate-text px-1">Load</span>
                            <video id="preview-3" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden w-4 h-4" id="loader-3"></div>
                        </button>
                        <div class="space-y-0.5">
                            <div class="flex justify-between text-[9px] text-gray-400 uppercase gap-1">
                                <span class="shrink-0">Start</span>
                                <span class="truncate-text" id="start-val-3">0%</span>
                            </div>
                            <input type="range" id="scrub-3" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                        </div>
                    </div>

                    <!-- Channel 4 -->
                    <div class="bg-[#1a1a1a] p-2 rounded border border-gray-800 relative group">
                        <div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 rounded-full bg-gray-700 shrink-0" id="status-4"></div>
                        <div class="flex justify-between items-center mb-1 gap-1">
                            <span class="font-bold text-[var(--neon-blue)] text-xs shrink-0">CH 4</span>
                            <span class="text-[10px] text-gray-500 font-mono truncate-text" id="time-4">00:00</span>
                        </div>
                        <input type="file" id="video-4" accept="video/*" class="hidden" onchange="handleVideoUpload(4, this)">
                        <button onclick="document.getElementById('video-4').click()" class="w-full h-14 bg-black border border-gray-700 flex items-center justify-center mb-1 hover:border-[var(--neon-blue)] transition-colors relative overflow-hidden">
                            <span class="text-gray-600 text-[10px] z-10 truncate-text px-1">Load</span>
                            <video id="preview-4" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden" muted loop playsinline></video>
                            <div class="loader absolute hidden w-4 h-4" id="loader-4"></div>
                        </button>
                        <div class="space-y-0.5">
                            <div class="flex justify-between text-[9px] text-gray-400 uppercase gap-1">
                                <span class="shrink-0">Start</span>
                                <span class="truncate-text" id="start-val-4">0%</span>
                            </div>
                            <input type="range" id="scrub-4" min="0" max="100" value="0" disabled class="opacity-50 w-full">
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center Stage -->
        <section class="flex-1 flex flex-col bg-black relative min-w-0">
            
            <!-- Trigger Buttons - MOVED TO TOP -->
            <div class="h-28 bg-[#0f0f0f] border-b border-gray-800 p-3 shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] text-gray-500 font-mono truncate-text">PADS [1] [2] [3] [4]</div>
                    <button id="btn-record" class="group relative px-4 py-2 bg-transparent border border-[var(--neon-red)] text-[var(--neon-red)] font-bold uppercase tracking-wider text-xs hover:bg-[var(--neon-red)] hover:text-white transition-all duration-200 overflow-hidden shrink-0 whitespace-nowrap">
                        <span class="relative z-10 flex items-center gap-1">
                            <div class="w-2 h-2 bg-current rounded-full shrink-0"></div>
                            <span class="truncate">Record</span>
                        </span>
                    </button>
                </div>

                <div class="grid grid-cols-4 gap-2 h-16">
                    <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center transition-all duration-100 group" data-ch="1">
                        <span class="text-xl font-bold text-gray-600 group-hover:text-[var(--neon-blue)] transition-colors">1</span>
                        <div class="absolute bottom-1.5 w-1 h-1 bg-gray-800 rounded-full status-light"></div>
                    </button>
                    <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center transition-all duration-100 group" data-ch="2">
                        <span class="text-xl font-bold text-gray-600 group-hover:text-[var(--neon-blue)] transition-colors">2</span>
                        <div class="absolute bottom-1.5 w-1 h-1 bg-gray-800 rounded-full status-light"></div>
                    </button>
                    <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center transition-all duration-100 group" data-ch="3">
                        <span class="text-xl font-bold text-gray-600 group-hover:text-[var(--neon-blue)] transition-colors">3</span>
                        <div class="absolute bottom-1.5 w-1 h-1 bg-gray-800 rounded-full status-light"></div>
                    </button>
                    <button class="trigger-btn relative bg-[#1a1a1a] border-2 border-gray-700 rounded-lg flex flex-col items-center justify-center transition-all duration-100 group" data-ch="4">
                        <span class="text-xl font-bold text-gray-600 group-hover:text-[var(--neon-blue)] transition-colors">4</span>
                        <div class="absolute bottom-1.5 w-1 h-1 bg-gray-800 rounded-full status-light"></div>
                    </button>
                </div>
            </div>

            <!-- Visual Output Area -->
            <div class="flex-1 relative flex items-center justify-center p-4 bg-[#050505] min-h-0">
                <canvas id="master-canvas" class="max-w-full max-h-full shadow-2xl border border-gray-800 bg-black crt" width="1280" height="720"></canvas>
                
                <div id="no-signal" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="text-center opacity-30">
                        <div class="text-6xl mb-2">üìº</div>
                        <div class="text-xl font-mono tracking-widest">NO SIGNAL</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Post-Record Modal -->
    <div id="modal-export" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-[#121212] border border-gray-700 p-6 md:p-8 rounded-lg max-w-md w-full text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[var(--neon-blue)] to-[var(--neon-lime)]"></div>
            <h2 class="text-2xl font-bold text-white mb-2">Performance Saved</h2>
            <p class="text-gray-400 mb-6 text-sm break-words">Your session has been rendered to MP4.</p>
            
            <div class="flex flex-col gap-3">
                <button id="btn-watch" class="w-full py-3 bg-[var(--neon-blue)] text-black font-bold uppercase tracking-wider hover:bg-white transition-colors truncate-text">
                    Watch Performance
                </button>
                <button id="btn-download" class="w-full py-3 border border-[var(--neon-lime)] text-[var(--neon-lime)] font-bold uppercase tracking-wider hover:bg-[var(--neon-lime)] hover:text-black transition-colors truncate-text">
                    Download MP4
                </button>
                <button id="btn-close-modal" class="w-full py-2 text-gray-500 text-sm hover:text-white mt-2 truncate-text">
                    Close & New Session
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Video Elements (with audio enabled) -->
    <div class="hidden">
        <video id="src-1" playsinline></video>
        <video id="src-2" playsinline></video>
        <video id="src-3" playsinline></video>
        <video id="src-4" playsinline></video>
    </div>

    <script>
        /**
         * APPLICATION STATE
         */
        const state = {
            channels: {
                1: { video: null, startTime: 0, duration: 0, loaded: false },
                2: { video: null, startTime: 0, duration: 0, loaded: false },
                3: { video: null, startTime: 0, duration: 0, loaded: false },
                4: { video: null, startTime: 0, duration: 0, loaded: false }
            },
            activeChannel: null,
            isRecording: false,
            mediaRecorder: null,
            recordedChunks: [],
            audioContext: null,
            audioAnalyser: null,
            audioDataArray: null,
            customAudioElement: null,
            audioGainNode: null,
            isPlaying: false,
            startTime: 0,
            timerInterval: null,
            // Metronome state
            metronome: {
                isActive: false,
                bpm: 120,
                intervalId: null,
                nextNoteTime: 0,
                volume: 0.5,
                includeInRecording: false,
                gainNode: null
            }
        };

        const canvas = document.getElementById('master-canvas');
        const ctx = canvas.getContext('2d');
        const noSignalOverlay = document.getElementById('no-signal');
        const recBtn = document.getElementById('btn-record');
        const recIndicator = document.getElementById('recording-indicator');
        const recTimer = document.getElementById('rec-timer');
        const playBeatBtn = document.getElementById('btn-play-beat');
        const audioVisualizer = document.getElementById('audio-visualizer');
        const visualizerCtx = audioVisualizer.getContext('2d');

        /**
         * INITIALIZATION
         */
        function init() {
            requestAnimationFrame(renderLoop);
            requestAnimationFrame(drawVisualizer);
            document.body.addEventListener('click', initAudio, { once: true });
            document.body.addEventListener('keydown', initAudio, { once: true });
            setupEventListeners();
        }

        function initAudio() {
            if (!state.audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                state.audioContext = new AudioContext();
            }
            if (state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
        }

        /**
         * METRONOME
         */
        function initMetronome() {
            if (!state.audioContext) initAudio();
            
            state.metronome.gainNode = state.audioContext.createGain();
            state.metronome.gainNode.gain.value = state.metronome.volume;
            state.metronome.gainNode.connect(state.audioContext.destination);
        }

        function playMetronomeClick() {
            if (!state.audioContext || !state.metronome.gainNode) return;
            
            const t = state.audioContext.currentTime;
            const osc = state.audioContext.createOscillator();
            const gain = state.audioContext.createGain();
            
            osc.frequency.setValueAtTime(1000, t);
            osc.type = 'square';
            
            gain.gain.setValueAtTime(state.metronome.volume, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
            
            osc.connect(gain);
            gain.connect(state.metronome.gainNode);
            
            osc.start(t);
            osc.stop(t + 0.05);
            
            const light = document.getElementById('metronome-light');
            light.classList.add('bg-[var(--neon-orange)]', 'glow-metronome');
            light.classList.remove('bg-gray-600');
            setTimeout(() => {
                light.classList.remove('bg-[var(--neon-orange)]', 'glow-metronome');
                light.classList.add('bg-gray-600');
            }, 100);
        }

        function scheduleMetronome() {
            const secondsPerBeat = 60.0 / state.metronome.bpm;
            
            while (state.metronome.nextNoteTime < state.audioContext.currentTime + 0.1) {
                playMetronomeClick();
                state.metronome.nextNoteTime += secondsPerBeat;
            }
            
            if (state.metronome.isActive) {
                state.metronome.intervalId = requestAnimationFrame(scheduleMetronome);
            }
        }

        function toggleMetronome() {
            const btn = document.getElementById('btn-metronome');
            const display = document.getElementById('metronome-display');
            
            if (state.metronome.isActive) {
                state.metronome.isActive = false;
                cancelAnimationFrame(state.metronome.intervalId);
                btn.textContent = 'START';
                btn.classList.remove('bg-red-500');
                btn.classList.add('bg-[var(--neon-orange)]');
                display.classList.add('hidden');
            } else {
                initMetronome();
                state.metronome.isActive = true;
                state.metronome.nextNoteTime = state.audioContext.currentTime;
                scheduleMetronome();
                btn.textContent = 'STOP';
                btn.classList.remove('bg-[var(--neon-orange)]');
                btn.classList.add('bg-red-500');
                display.classList.remove('hidden');
            }
        }

        /**
         * AUDIO VISUALIZER
         */
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            
            if (!state.audioAnalyser || !state.isPlaying) {
                visualizerCtx.fillStyle = '#000';
                visualizerCtx.fillRect(0, 0, audioVisualizer.width, audioVisualizer.height);
                return;
            }

            state.audioAnalyser.getByteFrequencyData(state.audioDataArray);
            
            visualizerCtx.fillStyle = '#000';
            visualizerCtx.fillRect(0, 0, audioVisualizer.width, audioVisualizer.height);
            
            const barWidth = (audioVisualizer.width / state.audioDataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < state.audioDataArray.length; i++) {
                barHeight = state.audioDataArray[i] / 2;
                visualizerCtx.fillStyle = `rgb(0, 243, 255)`;
                visualizerCtx.fillRect(x, audioVisualizer.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }
        }

        /**
         * VIDEO HANDLING
         */
        function handleVideoUpload(ch, input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 100 * 1024 * 1024) {
                showToast('File too large (Max 100MB)', 'error');
                return;
            }

            const loader = document.getElementById(`loader-${ch}`);
            loader.classList.remove('hidden');

            const url = URL.createObjectURL(file);
            const videoEl = document.getElementById(`src-${ch}`);
            const previewEl = document.getElementById(`preview-${ch}`);
            
            videoEl.src = url;
            previewEl.src = url;

            videoEl.onloadedmetadata = () => {
                loader.classList.add('hidden');
                previewEl.classList.remove('hidden');
                
                state.channels[ch].video = videoEl;
                state.channels[ch].duration = videoEl.duration;
                state.channels[ch].loaded = true;
                
                document.getElementById(`status-${ch}`).classList.replace('bg-gray-700', 'bg-[var(--neon-lime)]');
                document.getElementById(`scrub-${ch}`).disabled = false;
                document.getElementById(`scrub-${ch}`).classList.remove('opacity-50');
                document.getElementById(`time-${ch}`).innerText = formatTime(videoEl.duration);
                
                const scrubber = document.getElementById(`scrub-${ch}`);
                scrubber.oninput = (e) => {
                    const pct = e.target.value;
                    const time = (pct / 100) * videoEl.duration;
                    state.channels[ch].startTime = time;
                    document.getElementById(`start-val-${ch}`).innerText = pct + '%';
                    previewEl.currentTime = time;
                };
            };

            videoEl.onerror = () => {
                loader.classList.add('hidden');
                showToast('Error loading video', 'error');
            };
        }

        /**
         * PERFORMANCE LOGIC - Works anytime, not just during recording
         */
        function triggerChannel(ch, isActive) {
            const btn = document.querySelector(`.trigger-btn[data-ch="${ch}"]`);
            const light = btn.querySelector('.status-light');
            const videoEl = state.channels[ch].video;

            if (isActive) {
                btn.classList.add('active', 'glow-active');
                light.classList.replace('bg-gray-800', 'bg-[var(--neon-blue)]');
                light.classList.add('shadow-[0_0_10px_var(--neon-blue)]');
                
                if (videoEl) {
                    videoEl.currentTime = state.channels[ch].startTime;
                    videoEl.muted = false; // Ensure audio is enabled
                    videoEl.play();
                    state.activeChannel = ch;
                    noSignalOverlay.style.opacity = '0';
                }
            } else {
                btn.classList.remove('active', 'glow-active');
                light.classList.replace('bg-[var(--neon-blue)]', 'bg-gray-800');
                light.classList.remove('shadow-[0_0_10px_var(--neon-blue)]');
                
                if (state.activeChannel === ch) {
                    if (videoEl) videoEl.pause();
                    state.activeChannel = null;
                    noSignalOverlay.style.opacity = '1';
                }
            }
        }

        function stopAllPlayback() {
            // Stop all videos
            Object.values(state.channels).forEach(ch => {
                if (ch.video) {
                    ch.video.pause();
                }
            });
            
            // Reset UI
            document.querySelectorAll('.trigger-btn').forEach(btn => {
                btn.classList.remove('active', 'glow-active');
                const light = btn.querySelector('.status-light');
                light.classList.replace('bg-[var(--neon-blue)]', 'bg-gray-800');
                light.classList.remove('shadow-[0_0_10px_var(--neon-blue)]');
            });
            
            state.activeChannel = null;
            noSignalOverlay.style.opacity = '1';
            
            // Stop beat
            if (state.customAudioElement) {
                state.customAudioElement.pause();
                state.isPlaying = false;
                playBeatBtn.innerHTML = '‚ñ∂';
            }
            
            // Stop metronome
            if (state.metronome.isActive) {
                toggleMetronome();
            }
        }

        function setupEventListeners() {
            // Video triggers - work anytime (removed recording check)
            document.querySelectorAll('.trigger-btn').forEach(btn => {
                const ch = parseInt(btn.dataset.ch);
                
                const start = (e) => { 
                    e.preventDefault(); 
                    triggerChannel(ch, true); 
                };
                const end = (e) => { 
                    e.preventDefault(); 
                    triggerChannel(ch, false); 
                };

                btn.addEventListener('mousedown', start);
                btn.addEventListener('mouseup', end);
                btn.addEventListener('mouseleave', end);
                btn.addEventListener('touchstart', start);
                btn.addEventListener('touchend', end);
            });

            // Keyboard triggers - work anytime
            window.addEventListener('keydown', (e) => {
                if (e.repeat) return;
                if (e.key === '1') triggerChannel(1, true);
                if (e.key === '2') triggerChannel(2, true);
                if (e.key === '3') triggerChannel(3, true);
                if (e.key === '4') triggerChannel(4, true);
            });

            window.addEventListener('keyup', (e) => {
                if (e.key === '1') triggerChannel(1, false);
                if (e.key === '2') triggerChannel(2, false);
                if (e.key === '3') triggerChannel(3, false);
                if (e.key === '4') triggerChannel(4, false);
            });

            // Metronome controls
            document.getElementById('btn-metronome').addEventListener('click', toggleMetronome);
            
            document.getElementById('bpm-slider').addEventListener('input', (e) => {
                state.metronome.bpm = parseInt(e.target.value);
                document.getElementById('bpm-value').textContent = state.metronome.bpm;
                document.getElementById('bpm-display').textContent = state.metronome.bpm;
            });
            
            document.getElementById('metronome-vol').addEventListener('input', (e) => {
                state.metronome.volume = parseFloat(e.target.value);
                if (state.metronome.gainNode) {
                    state.metronome.gainNode.gain.value = state.metronome.volume;
                }
            });
            
            document.getElementById('metronome-record-toggle').addEventListener('change', (e) => {
                state.metronome.includeInRecording = e.target.checked;
                document.getElementById('metronome-record-status').textContent = e.target.checked ? 'YES' : 'NO';
                document.getElementById('metronome-record-status').className = e.target.checked ? 'text-[var(--neon-red)]' : 'text-[var(--neon-lime)]';
            });

            // Audio Upload
            document.getElementById('audio-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    initAudio();
                    
                    const url = URL.createObjectURL(file);
                    if (state.customAudioElement) {
                        state.customAudioElement.pause();
                        state.customAudioElement.src = '';
                    }
                    
                    const audio = new Audio(url);
                    audio.loop = true;
                    audio.crossOrigin = 'anonymous';
                    state.customAudioElement = audio;
                    
                    const source = state.audioContext.createMediaElementSource(audio);
                    const analyser = state.audioContext.createAnalyser();
                    analyser.fftSize = 64;
                    state.audioAnalyser = analyser;
                    state.audioDataArray = new Uint8Array(analyser.frequencyBinCount);
                    
                    const gainNode = state.audioContext.createGain();
                    gainNode.gain.value = document.getElementById('beat-vol').value;
                    
                    source.connect(analyser);
                    analyser.connect(gainNode);
                    gainNode.connect(state.audioContext.destination);
                    
                    state.audioGainNode = gainNode;
                    
                    document.getElementById('beat-filename').textContent = file.name;
                    document.getElementById('beat-filename').classList.remove('hidden');
                    playBeatBtn.disabled = false;
                    showToast('Beat loaded: ' + file.name, 'success');
                }
            });

            // Play/Pause Beat
            playBeatBtn.addEventListener('click', () => {
                if (!state.customAudioElement) return;
                
                if (state.isPlaying) {
                    state.customAudioElement.pause();
                    playBeatBtn.innerHTML = '‚ñ∂';
                    state.isPlaying = false;
                } else {
                    initAudio();
                    state.customAudioElement.play();
                    playBeatBtn.innerHTML = '‚è∏';
                    state.isPlaying = true;
                }
            });

            // Volume
            document.getElementById('beat-vol').addEventListener('input', (e) => {
                if (state.audioGainNode) {
                    state.audioGainNode.gain.value = e.target.value;
                }
                if (state.customAudioElement) {
                    state.customAudioElement.volume = e.target.value;
                }
            });

            // Record
            recBtn.addEventListener('click', toggleRecording);

            // Modal
            document.getElementById('btn-close-modal').addEventListener('click', () => {
                document.getElementById('modal-export').classList.add('hidden');
                recBtn.classList.remove('glow-record');
                recBtn.innerHTML = '<span class="relative z-10 flex items-center gap-1"><div class="w-2 h-2 bg-current rounded-full shrink-0"></div><span class="truncate">Record</span></span>';
            });
            
            document.getElementById('btn-setup-toggle').addEventListener('click', () => {
                const panel = document.getElementById('setup-panel');
                if (panel.style.marginLeft === '-288px') {
                    panel.style.marginLeft = '0';
                } else {
                    panel.style.marginLeft = '-288px';
                }
            });
        }

        /**
         * RENDER LOOP
         */
        function renderLoop() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (state.activeChannel && state.channels[state.activeChannel].video) {
                const video = state.channels[state.activeChannel].video;
                const scale = Math.min(canvas.width / video.videoWidth, canvas.height / video.videoHeight);
                const x = (canvas.width / 2) - (video.videoWidth / 2) * scale;
                const y = (canvas.height / 2) - (video.videoHeight / 2) * scale;
                
                ctx.drawImage(video, x, y, video.videoWidth * scale, video.videoHeight * scale);
            }

            requestAnimationFrame(renderLoop);
        }

        /**
         * RECORDING WITH AUDIO
         */
        async function toggleRecording() {
            if (state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            const hasVideo = Object.values(state.channels).some(c => c.loaded);
            if (!hasVideo) {
                showToast('Load at least one video first!', 'error');
                return;
            }

            initAudio();
            
            // Start beat if loaded
            if (state.customAudioElement) {
                state.customAudioElement.currentTime = 0;
                state.customAudioElement.play();
                state.isPlaying = true;
                playBeatBtn.innerHTML = '‚è∏';
            }

            const canvasStream = canvas.captureStream(30);
            const dest = state.audioContext.createMediaStreamDestination();
            
            // Route video audio through destination
            Object.values(state.channels).forEach(ch => {
                if (ch.video) {
                    try {
                        const videoStream = ch.video.captureStream();
                        const videoAudioTrack = videoStream.getAudioTracks()[0];
                        if (videoAudioTrack) {
                            const videoSource = state.audioContext.createMediaStreamSource(new MediaStream([videoAudioTrack]));
                            videoSource.connect(dest);
                        }
                    } catch (e) {}
                }
            });
            
            // Route beat audio through destination
            if (state.customAudioElement && state.audioGainNode) {
                state.audioGainNode.connect(dest);
            }
            
            // Route metronome to destination ONLY if included in recording
            if (state.metronome.isActive && state.metronome.includeInRecording && state.metronome.gainNode) {
                state.metronome.gainNode.connect(dest);
            }
            
            const combinedStream = new MediaStream([
                ...canvasStream.getVideoTracks(),
                ...dest.stream.getAudioTracks()
            ]);

            state.mediaRecorder = new MediaRecorder(combinedStream, { 
                mimeType: 'video/webm;codecs=vp9,opus' 
            });
            state.recordedChunks = [];

            state.mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) state.recordedChunks.push(e.data);
            };

            state.mediaRecorder.onstop = () => {
                if (state.metronome.gainNode && state.metronome.includeInRecording) {
                    try {
                        state.metronome.gainNode.disconnect(dest);
                    } catch(e) {}
                }
                
                stopAllPlayback();
                
                const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                const modal = document.getElementById('modal-export');
                modal.classList.remove('hidden');
                
                document.getElementById('btn-download').onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `neon-performance-${Date.now()}.webm`;
                    a.click();
                };

                document.getElementById('btn-watch').onclick = () => {
                    const win = window.open();
                    win.document.write('<iframe src="' + url + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
                };
            };

            state.mediaRecorder.start();
            state.isRecording = true;
            
            recBtn.classList.add('glow-record');
            recBtn.innerHTML = '<span class="relative z-10 flex items-center gap-1"><div class="w-2 h-2 bg-white rounded-sm shrink-0"></div><span class="truncate">Stop</span></span>';
            recIndicator.classList.remove('hidden');
            
            let seconds = 0;
            recTimer.innerText = "00:00";
            state.timerInterval = setInterval(() => {
                seconds++;
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                recTimer.innerText = `${m}:${s}`;
            }, 1000);

            showToast('Recording Started', 'success');
        }

        function stopRecording() {
            if (state.mediaRecorder && state.isRecording) {
                state.mediaRecorder.stop();
                state.isRecording = false;

                recBtn.classList.remove('glow-record');
                recBtn.innerHTML = '<span class="relative z-10 flex items-center gap-1"><div class="w-2 h-2 bg-current rounded-full shrink-0"></div><span class="truncate">Record</span></span>';
                recIndicator.classList.add('hidden');
                clearInterval(state.timerInterval);
                
                showToast('Processing Video...', 'success');
            }
        }

        /**
         * UTILITIES
         */
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function showToast(msg, type = 'error') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="text-lg shrink-0">${type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                <span class="break-words">${msg}</span>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        init();

    </script>
</body>
</html>
